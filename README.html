<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>readme</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="README_files/libs/clipboard/clipboard.min.js"></script>
<script src="README_files/libs/quarto-html/quarto.js"></script>
<script src="README_files/libs/quarto-html/popper.min.js"></script>
<script src="README_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="README_files/libs/quarto-html/anchor.min.js"></script>
<link href="README_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="README_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="README_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="README_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="README_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">



<p>In this lab you’ll be learning the end-to-end machine learning process that involves data preparation, training a model, registering the model and debug them. First you will go through the process of training the model locally. Then you will learn how to make your machine learning model training process more dynamic, manageable and scalable in the cloud using Azure Machine Learning service. For the workshop we’ll be using the <a href="https://archive.ics.uci.edu/ml/machine-learning-databases/00296/">UCI hospital diabetes dataset</a> to train a classification model using the Scikit-Learn framework. The model will predict whether or not a diabetic patient will be readmitted back to a hospital with 30 days of being discharged. To prep the data to be used for training our model we are going to review our dataset to cleanse any redundant data, missing values, reformat data or delete any irrelevant data that will be used for our use case. After the data has been clean, we’ll train.</p>
<section id="exercise-1-training-a-model-locally" class="level1">
<h1>Exercise 1: Training a model locally</h1>
<section id="task-1-data-prep" class="level2">
<h2 class="anchored" data-anchor-id="task-1-data-prep">Task #1: Data Prep</h2>
<p>For this exercise, you’ll load the <strong>1-dataprep-and-training-local.ipynb</strong> jupyter notebook.</p>
<p>The first thing we need is to read the hospital diabetes data into a dataframe that will allow us to visualize and perform data manipulation. To do this will be using the read_csv function from the “pandas” library.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">'diabetic_data.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Next, take a look at the size of the data to verify that it will be sufficient for our training. As you can see 101,766 is a very large data set.</p>
<p>Let’s display the dataframe to see what kind of diabetes is in the hospital data. As you can see it have the patient race, gender, age, weight, their prior hospitalization inform, prescribed medication and whether or not they were readmitted back to the hospital.</p>
<p><em>Checking for special characters</em></p>
<p>One of the invalid data that stands out from the Weight column is the “?” special characters that are used as fillers in our dataset. We’ll loop through the dataset to identify columns that have this special character.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df.loc[: , (df <span class="op">==</span> <span class="st">'?'</span>).<span class="bu">any</span>()])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The output shows that that race, weight, payer_code, medical_specialty, diag_1, diag_2, and diag_3 are the column with missing values that have the special character. To fix this we’ll change the character to null by using the numpy NAN function.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.replace(<span class="st">'?'</span>, np.NaN) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><em>Checking for null values</em></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df.isna().<span class="bu">any</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When we run the “isna” function on the dataframe, we can see that there are 7 columns with null values in our dataset. Depending on the number of null values that a column has, we’ll keep or delete the column. As we count the columns with a high number of null values from the weight column. Although, Weight is liking to impact a diabetes patient’s readmission status, a majority of it’s values are null. Race is another column that has 12% of its values missing. This is not a signification number; we can drop the null values. The null values from payer_code and medical_specialty are significant either, so can drop the fields.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.dropna()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><em>Deleting irrelevant columns</em></p>
<p>The patient’s form of payment does not have impact on the return to the hospital, so we dropped the Payer_Code. However, we added the Medicare and Medicaid column to indicate whether or not the Payer_Code for the hospital bill used a subsidize government medical assistance for low-income patients. This is to help us understand if there are any socioeconomic gaps in the diabetic patient demographic.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>df.loc[:, <span class="st">"medicare"</span>] <span class="op">=</span> (df.payer_code <span class="op">==</span> <span class="st">"MC"</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>df.loc[:, <span class="st">"medicaid"</span>] <span class="op">=</span> (df.payer_code <span class="op">==</span> <span class="st">"MD"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>There are 20+ columns of whether or not a patient took a certain diabetic medication (rosiglitazon, citoglipton, metformin etc.) that have no correlation on a patient’s return to the hospital. As result, we’ll delete these medications.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>df.drop([<span class="st">'encounter_id'</span>, <span class="st">'patient_nbr'</span>, <span class="st">'weight'</span>, <span class="st">'payer_code'</span>, <span class="st">'medical_specialty'</span>, <span class="st">'admission_type_id'</span>, </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>         <span class="st">'repaglinide'</span>,<span class="st">'nateglinide'</span>,<span class="st">'chlorpropamide'</span>,<span class="st">'glimepiride'</span>,<span class="st">'acetohexamide'</span>,<span class="st">'glipizide'</span>,<span class="st">'glyburide'</span>,<span class="st">'tolbutamide'</span>,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">'pioglitazone'</span>,<span class="st">'rosiglitazone'</span>,<span class="st">'acarbose'</span>,<span class="st">'miglitol'</span>,<span class="st">'troglitazone'</span>,<span class="st">'tolazamide'</span>,<span class="st">'examide'</span>,<span class="st">'citoglipton'</span>, <span class="st">'metformin'</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">'glyburide-metformin'</span>,<span class="st">'glipizide-metformin'</span>,<span class="st">'glimepiride-pioglitazone'</span>,<span class="st">'metformin-rosiglitazone'</span>,<span class="st">'metformin-pioglitazone'</span>, <span class="st">'diag_2'</span>, <span class="st">'diag_3'</span>, <span class="st">'change'</span>], axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Lastly, unique patient numbers or hospital record identifications do not have value to model. Also, a patient’s first, second or third diagnosis while that were hospitalized may be useful , but are too random from patient to patient.</p>
<p><em>Formatting data</em></p>
<p>Part of working with data is formatting the columns or values into names that are more meaningful and easier to understand. Here we’ll change the readmitted outcome from NO or &lt;30.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'readmitted'</span>] <span class="op">=</span> df[<span class="st">'readmitted'</span>].replace({<span class="st">"NO"</span>:<span class="st">"not readmitted"</span>, <span class="st">"&lt;30"</span>:<span class="st">"readmitted"</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Next, the age group are represented in brackets. For example, [0 - 10] denotes the age between 0 and 10 years old. In addition, since there’s a small sample size of patients in this age group will consolidate the age groups.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>df.loc[:, <span class="st">"age"</span>] <span class="op">=</span> df[<span class="st">"age"</span>].replace( [<span class="st">"[0-10)"</span>, <span class="st">"[10-20)"</span>, <span class="st">"[20-30)"</span>], <span class="st">"30 years or younger"</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>df.loc[:, <span class="st">"age"</span>] <span class="op">=</span> df[<span class="st">"age"</span>].replace([<span class="st">"[30-40)"</span>, <span class="st">"[40-50)"</span>, <span class="st">"[50-60)"</span>], <span class="st">"30-60 years"</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>df.loc[:, <span class="st">"age"</span>] <span class="op">=</span> df[<span class="st">"age"</span>].replace([<span class="st">"[60-70)"</span>, <span class="st">"[70-80)"</span>, <span class="st">"[80-90)"</span>, <span class="st">"[90-100)"</span>], <span class="st">"Over 60 years"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="task-2-training-data" class="level2">
<h2 class="anchored" data-anchor-id="task-2-training-data">Task # 2: Training data</h2>
<p>Now that the data has been cleansed, it is ready to be used for training our model. To do this we will split out data into training and testing data sets with scikit-learns train_test_spilt function. This is optional, but we will store our data for later use. The file format we’ll use for our dataset is parquet.</p>
<p>Next, to normalize our data, we’ll create a helper function that identified all the indices for the non-numeric columns. Scikit-Learn’s OneHotEncoder will be used to encode all the string or object columns. Next, we’ll use the StandardScalar to encode the number column fields. The ColumnTransformer will be use to perform the data transformation. Where create a pipeline to put all of these prepressing tasks for the model to execute before training the model.</p>
<p>For our diabetes readmission classification, we use the LogisticRegression model on our dataset.</p>
<p>After training the model, we can review the accuracy score to evaluate how well our trained model performed. The score of 0.86 looks good.</p>
</section>
</section>
<section id="exercise-2-training-a-model-in-the-cloud" class="level1">
<h1>Exercise 2: Training a model in the cloud</h1>
<p>In the previous lab, we used the diabetes hospital readmission dataset to understand and wrangled data into a clean dataset to train a classification model to predication whether a diabetics patient would be readmitted back to a hospital within 30 days of being discharge. All of this done on the local machine. In this session, you will learn how to train a model in the cloud using the end-to-end streamline process to make your model reproduceable, easier to manage, and scalable.</p>
<section id="task-1-create-a-cloud-client" class="level2">
<h2 class="anchored" data-anchor-id="task-1-create-a-cloud-client">Task# 1: Create a cloud client*</h2>
<p>Before you can use the Azure Machine Learning studio, you need to create a cloud client session to authenticate and connect to the workspace. The authorization needs the subscription id, resource group, and name of the Azure ML workspace.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>registry_name <span class="op">=</span> <span class="st">"azureml"</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>credential <span class="op">=</span> DefaultAzureCredential()</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>ml_client <span class="op">=</span>  MLClient.from_config(credential<span class="op">=</span>credential)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>ml_client_registry <span class="op">=</span> MLClient(</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    credential<span class="op">=</span>credential,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    subscription_id<span class="op">=</span>ml_client.subscription_id,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    resource_group_name<span class="op">=</span>ml_client.resource_group_name,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    registry_name<span class="op">=</span>registry_name</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="task-2-register-the-dataset" class="level2">
<h2 class="anchored" data-anchor-id="task-2-register-the-dataset">Task 2: Register the dataset</h2>
<p>Data preparation is a long and tedious process the takes up a majority of the machine learning process. After you have cleanse into a good state, Azure Machine Learning provides datastores for you to register and store your datasets to. Your dataset is stored in one location, but it can be referenced as a point without having to move the data. The benefit of registering your datasets is, individuals on your team can reference them; and you can track all the experiments that used.</p>
<p>We are going to use the training and testing data that you used in Lab#1 and register it to the cloud. To register the files to Azure, we need to use the connect client. In the case, we need to specify the locally directory path. The AssetTypes.URI_FILE specifies what time of data file we are using.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> azure.ai.ml.entities <span class="im">import</span> Data</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> azure.ai.ml.constants <span class="im">import</span> AssetTypes</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>training_data <span class="op">=</span> Data(</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span>training_dataset_filename,</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    path<span class="op">=</span><span class="st">'data/train_dataset.parquet'</span>,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span><span class="op">=</span>AssetTypes.URI_FILE,</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    description<span class="op">=</span><span class="st">"Patient train data"</span>,  </span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>tr_data <span class="op">=</span> ml_client.data.create_or_update(training_data)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>testing_data <span class="op">=</span> Data(</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span>testing_dataset_filename,</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    path<span class="op">=</span><span class="st">'data/test_dataset.parquet'</span>,</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span><span class="op">=</span>AssetTypes.URI_FILE,</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    description<span class="op">=</span><span class="st">"Patient test data"</span>,  </span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>te_data <span class="op">=</span> ml_client.data.create_or_update(testing_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="task-3-create-a-compute" class="level2">
<h2 class="anchored" data-anchor-id="task-3-create-a-compute">Task 3: Create a Compute</h2>
<p>To run a job or machine learning computation, we need to create a compute instance. You can create none in notebook or use existing one. To create a compute, you need a name and the size of the instance. You can also specify how you and the instance to scare during runtime.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> azure.ai.ml.entities <span class="im">import</span> AmlCompute</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>compute_name <span class="op">=</span> <span class="st">"trainingcompute"</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>all_compute_names <span class="op">=</span> [x.name <span class="cf">for</span> x <span class="kw">in</span> ml_client.compute.<span class="bu">list</span>()]</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> compute_name <span class="kw">in</span> all_compute_names:</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Found existing compute: </span><span class="sc">{</span>compute_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    my_compute <span class="op">=</span> AmlCompute(</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span>compute_name,</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>        size<span class="op">=</span><span class="st">"Standard_DS2_v2"</span>,</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>        min_instances<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>        max_instances<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        idle_time_before_scale_down<span class="op">=</span><span class="dv">3600</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    ml_client.compute.begin_create_or_update(my_compute)</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Initiated compute creation"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="task-4-create-an-environment" class="level2">
<h2 class="anchored" data-anchor-id="task-4-create-an-environment">Task 4: Create an environment</h2>
<p>An environment specifies all the dependencies that a task or job that you need to run need. This can include python version, docker file, python libraries, etc. You have the option of creating a custom environment from scratch that suits your needs or use one of the Azure Machine Learning curated environments available. In our case, we are using Responsible AI’s out of the box curated environment: <em>AzureML-responsibleai-0.20-ubuntu20.04-py38-cpu</em> since we’ll need needing it in the next lab. (<strong>NOTE</strong>: Select the Environments tab in Azure Machine Learn Studio to see the available environments)</p>
</section>
<section id="task-5-define-the-training-model" class="level2">
<h2 class="anchored" data-anchor-id="task-5-define-the-training-model">Task 5: Define the training model</h2>
<p>We’ll be using Azure Machine Learning components to divide the experiment into different tasks. Components are reusable independent units of tasks that have inputs and output in machine learning (e.g., data cleaning, training a model, registering a model, deploying a model etc.). For our experiment, we will create a component for training a model. The component will consist of a python training code with inputs and outputs.</p>
<p>The first thing to define in our python code is the training script containing a function that declares an argument parser object that adds the names and types for the input and output parameters. For our Diabetes Hospital Readmission use case, we will be passing the path to our training dataset and the target column name as the classifier. Then the trained model will be the output for the script.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_args():</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># setup arg parser</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser()</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add arguments</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">"--training_data"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Path to training data"</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">"--target_column_name"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Name of target column"</span>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">"--model_output"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Path of output model"</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># parse args</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()    </span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># return args</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> args</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In our python code, we’ll define a main class that the takes the input arguments to train the month. As you will see the code to change the model remain the same. The only change is create an experiment in Azure Machine Learning studio and using MLFlow to start the artifacts and metrics from your training model for tracking.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>current_experiment <span class="op">=</span> Run.get_context().experiment</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>tracking_uri <span class="op">=</span> current_experiment.workspace.get_mlflow_tracking_uri()</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>mlflow.set_tracking_uri(tracking_uri)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>mlflow.set_experiment(current_experiment.name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>After your model has been training. We’ll store the Scikit-Learn model output in a local directory then with MLFlow’s save_model function for scikit-learn models to save the model output.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>    model_dir <span class="op">=</span>  <span class="st">"./model_output"</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> tempfile.TemporaryDirectory() <span class="im">as</span> td:</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Saving model with MLFlow to temporary directory"</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>        tmp_output_dir <span class="op">=</span> os.path.join(td, model_dir)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>        mlflow.sklearn.save_model(sk_model<span class="op">=</span>model, path<span class="op">=</span>tmp_output_dir)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Copying MLFlow model to output path"</span>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> file_name <span class="kw">in</span> os.listdir(tmp_output_dir):</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"  Copying: "</span>, file_name)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>            <span class="co"># As of Python 3.8, copytree will acquire dirs_exist_ok as</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>            <span class="co"># an option, removing the need for listdir</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>            shutil.copy2(src<span class="op">=</span>os.path.join(tmp_output_dir, file_name), dst<span class="op">=</span>os.path.join(args.model_output, file_name))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Once you have defined you python code with the arguments and the main function to execute, we can create a compute to load the python to Azure Machine Learning components.</p>
</section>
<section id="task-6-create-a-job" class="level2">
<h2 class="anchored" data-anchor-id="task-6-create-a-job">Task 6: Create a job</h2>
<p>To define our training component, we’ll need to create a yaml file where we specified the component name, input, and output parameters; the location of the python code that trains the model; the command-line to execute the python code; and the environment to run the code. You can use Azure Machine Learning the Responsible AI’s out of the box curated environment: <em>AzureML-responsibleai-0.20-ubuntu20.04-py38-cpu</em>. Then use the client session to register the component definition in workspace components.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> azure.ai.ml <span class="im">import</span> load_component</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>yaml_contents <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="ss">$schema: http://azureml/sdk-2-0/CommandComponent.json</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="ss">name: rai_hospital_training_component</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="ss">display_name: hospital  classification training component for RAI example</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="ss">version: </span><span class="sc">{</span>rai_hospital_classifier_version_string<span class="sc">}</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="ss">type: command</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="ss">inputs:</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="ss">  training_data:</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="ss">    type: path</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="ss">  target_column_name:</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="ss">    type: string</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="ss">outputs:</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="ss">  model_output:</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="ss">    type: path</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="ss">code: ./component/</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="ss">environment: azureml://registries/azureml/environments/AzureML-responsibleai-0.20-ubuntu20.04-py38-cpu/versions/4</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span> <span class="op">+</span> <span class="vs">r"""</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="vs">command: &gt;-</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="vs">  python hospital_training.py</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="vs">  --training_data $</span><span class="sc">{{{{</span><span class="vs">inputs.training_data</span><span class="sc">}}}}</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="vs">  --target_column_name $</span><span class="sc">{{{{</span><span class="vs">inputs.target_column_name</span><span class="sc">}}}}</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="vs">  --model_output $</span><span class="sc">{{{{</span><span class="vs">outputs.model_output</span><span class="sc">}}}}</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a><span class="vs">"""</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>yaml_filename <span class="op">=</span> <span class="st">"RAIhospitalClassificationTrainingComponent.yaml"</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(yaml_filename, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>    f.write(yaml_contents.<span class="bu">format</span>(yaml_contents))</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>train_component_definition <span class="op">=</span> load_component(</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>    source<span class="op">=</span>yaml_filename</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>ml_client.components.create_or_update(train_component_definition)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="task-7-create-a-pipeline-in-the-cloud" class="level2">
<h2 class="anchored" data-anchor-id="task-7-create-a-pipeline-in-the-cloud">Task 7: Create a pipeline in the cloud</h2>
<p>An Azure Machine Learning pipeline packages all the components and runs them sequentially during runtime with a specified compute instance, docker images or conda environments in the job process. After the training component defined above has been created, we need to define the pipeline that is going to package all the dependencies needed to run the training experiment. To do this, you will need the following:</p>
<ul>
<li>The experiment name and description</li>
<li>Input object for the training dataset path</li>
<li>Input object for the testing dataset path</li>
<li>Get component name that trains the model</li>
<li>Get component name that registers the model</li>
<li>The compute instance for running the training job All of this information is packaged in a pipeline job to run the experiment for training and registering the model.</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> azure.ai.ml <span class="im">import</span> dsl, Input</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>hospital_train_parquet <span class="op">=</span> Input(</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>, path<span class="op">=</span><span class="st">"data/train_dataset.parquet"</span>, mode<span class="op">=</span><span class="st">"download"</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>hospital_test_parquet <span class="op">=</span> Input(</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>, path<span class="op">=</span><span class="st">"data/test_dataset.parquet"</span>, mode<span class="op">=</span><span class="st">"download"</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="at">@dsl.pipeline</span>(</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    compute<span class="op">=</span>compute_name,</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    description<span class="op">=</span><span class="st">"Register Model for RAI hospital "</span>,</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    experiment_name<span class="op">=</span><span class="ss">f"RAI_hospital_Model_Training_</span><span class="sc">{</span>model_name_suffix<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> my_training_pipeline(target_column_name, training_data):</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    trained_model <span class="op">=</span> train_component_definition(</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>        target_column_name<span class="op">=</span>target_column_name,</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>        training_data<span class="op">=</span>training_data</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    trained_model.set_limits(timeout<span class="op">=</span><span class="dv">120</span>)</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    _ <span class="op">=</span> register_component(</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>        model_input_path<span class="op">=</span>trained_model.outputs.model_output,</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>        model_base_name<span class="op">=</span>model_base_name,</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>        model_name_suffix<span class="op">=</span>model_name_suffix,</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {}</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>model_registration_pipeline_job <span class="op">=</span> my_training_pipeline(target_column, hospital_train_parquet)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="task-8-run-the-training-job" class="level2">
<h2 class="anchored" data-anchor-id="task-8-run-the-training-job">Task 8: Run the training job</h2>
<p>Once you have defined and registered the pipeline to the workspace, you can submit the pipeline to run in a job. In our python code, we are checking the status of the job.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> azure.ai.ml.entities <span class="im">import</span> PipelineJob</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> webbrowser</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> submit_and_wait(ml_client, pipeline_job) <span class="op">-&gt;</span> PipelineJob:</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    created_job <span class="op">=</span> ml_client.jobs.create_or_update(pipeline_job)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> created_job <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> created_job.status <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'Completed'</span>, <span class="st">'Failed'</span>, <span class="st">'Canceled'</span>, <span class="st">'NotResponding'</span>]:</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="dv">30</span>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>        created_job <span class="op">=</span> ml_client.jobs.get(created_job.name)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Latest status : </span><span class="sc">{0}</span><span class="st">"</span>.<span class="bu">format</span>(created_job.status))</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># open the pipeline in web browser</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    webbrowser.<span class="bu">open</span>(created_job.services[<span class="st">"Studio"</span>].endpoint)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">#assert created_job.status == 'Completed'</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> created_job</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="co"># This is the actual submission</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>training_job <span class="op">=</span> submit_and_wait(ml_client, model_registration_pipeline_job)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To monitor progess of the job and status of all the components in the pipeline job is by clicking on the Jobs icon from the Azure Machine Learning Studio.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="/img/training-job.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">training job</figcaption><p></p>
</figure>
</div>
<p>From the Jobs list, you can click on the job to view the jobs progress and can drill-down to pinpoint where an error occurred. You will see the Diabetes Hospital Readmission dataset feeding as an input into our training component and the output model feeding into the register model marked as complete. After the pipeline has successfully finished running, you will have a trained model that is registered to the Azure Machine Learning Studio.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="/img/training-job-progress.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">training job progress</figcaption><p></p>
</figure>
</div>
</section>
</section>
<section id="exercise-3-add-a-responsible-ai-dashboard" class="level1">
<h1>Exercise 3: Add a Responsible AI dashboard</h1>
<p>In this exercise, you’ll be learning how to create the Responsible AI dashboard for the trained model. This will help us get a hoslitic insights from our diabetes hospital readmission model. In addition, it will expose any errors or areas where there could be undesireable responsible AI issues. The dashboard is comprised of different components to enable you to debug and analyze the model performance, identify errors, performance fairness assessment, performance model interpretability and more. The dashboard can be create using the Azure Portal, CLI or SDK. In this exercise, we will be using the SDK to create the dashboard.</p>
<section id="task-1-define-the-dashboard-components" class="level2">
<h2 class="anchored" data-anchor-id="task-1-define-the-dashboard-components">Task 1: Define the dashboard components</h2>
<p>The Responsible AI dashboard components are already pre-defined in the Azure Machine Learning studio. To use the components, you need submit the component name and version to the Azure Machine Learn clients session created in the previous exercise. The user have the option to add a many components they want on the Responsible AI dashboard. The components you’ll be are:</p>
<ul>
<li>Error Analysis</li>
<li>Explanation</li>
<li>Insight Gather</li>
</ul>
<div class="sourceCode" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>label <span class="op">=</span> <span class="st">"latest"</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>rai_constructor_component <span class="op">=</span> ml_client_registry.components.get(</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"microsoft_azureml_rai_tabular_insight_constructor"</span>, label<span class="op">=</span>label</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co"># We get latest version and use the same version for all components</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>version <span class="op">=</span> rai_constructor_component.version</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>rai_explanation_component <span class="op">=</span> ml_client_registry.components.get(</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"microsoft_azureml_rai_tabular_explanation"</span>, version<span class="op">=</span>version</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>rai_erroranalysis_component <span class="op">=</span> ml_client_registry.components.get(</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"microsoft_azureml_rai_tabular_erroranalysis"</span>, version<span class="op">=</span>version</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>rai_gather_component <span class="op">=</span> ml_client_registry.components.get(</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"microsoft_azureml_rai_tabular_insight_gather"</span>, version<span class="op">=</span>version</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="task-2-create-the-job-to-create-the-dashboard" class="level2">
<h2 class="anchored" data-anchor-id="task-2-create-the-job-to-create-the-dashboard">Task 2: Create the job to create the dashboard</h2>
<p>When you have specified the RAI components you need, it is time to define an <a href="https://aka.ms/MBAzureMLPipeline">Azure pipeline</a> and config each RAI component. For the list of settings needed to configure each of your RAI components, refer to <a href="https://aka.ms/MBARAIComponentSettings">RAI component parameters</a>.</p>
<p>To define the pipeline for the RAI Dashboard, declare the experiment name, description and the name of the compute server that will be running the pipeline job. We use the <a href="https://docs.microsoft.com/python/api/azure-ai-ml/azure.ai.ml.dsl?view=azure-python-preview%22%20%5Ct%20%22_blank">dsl.pipeline</a> annotation above the pipeline function to specify these fields.</p>
<p>The RAI constructor component is what initializes the global data needed for the different components for the RAI dashboard. The constructor component takes the following parameters:</p>
<ul>
<li><em>title</em> - The title of the dashboard.</li>
<li><em>task_type</em> - Our Diabetes Hospital Readmission is a classification use-case, so we’ll set value to classification.</li>
<li><em>model_info</em> - the model output path</li>
<li><em>model_input</em> - the MLFlow model input path</li>
<li><em>train_dataset</em> - the registered training dataset location</li>
<li><em>test_dataset</em> - the registered testing dataset location</li>
<li><em>target_column_name</em> - the target column our model is trying to predict</li>
<li><em>categorical_column_names</em> - the columns in our dataset that have non-numeric values</li>
</ul>
<div class="sourceCode" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Initiate the RAIInsights</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>        create_rai_job <span class="op">=</span> rai_constructor_component(</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>            title<span class="op">=</span><span class="st">"RAI Dashboard"</span>,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>            task_type<span class="op">=</span><span class="st">"classification"</span>,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>            model_info<span class="op">=</span>expected_model_id,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>            model_input<span class="op">=</span>Input(<span class="bu">type</span><span class="op">=</span>AssetTypes.MLFLOW_MODEL, path<span class="op">=</span>azureml_model_id),            </span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>            train_dataset<span class="op">=</span>training_data,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>            test_dataset<span class="op">=</span>testing_data,</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>            target_column_name<span class="op">=</span>target_column_name,</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>            categorical_column_names<span class="op">=</span>json.dumps(categorical),</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>        create_rai_job.set_limits(timeout<span class="op">=</span><span class="dv">120</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The Explanation component is responsible for the dashboard providing a better understanding of what features influence the model’s predictions. It takes the a comment description pertaining to your use case. Then set the <em>rai_insights_dashboard</em> to be the output insights generated from the RAI pipeline job for Explanations.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Explanation</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>        explanation_job <span class="op">=</span> rai_explanation_component(</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>            comment<span class="op">=</span><span class="st">"Explain the model"</span>,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>            rai_insights_dashboard<span class="op">=</span>create_rai_job.outputs.rai_insights_dashboard,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>        explanation_job.set_limits(timeout<span class="op">=</span><span class="dv">120</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The Error Analysis component is responsible for the dashboard providing an error distribution of the feature groups contributing to the error rate of the model. Its only configuration is to set the <em>rai_insights_dashboard</em> to be the output insights generated from the RAI pipeline job for the overall and feature error rates.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Error Analysis</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>        erroranalysis_job <span class="op">=</span> rai_erroranalysis_component(</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>            rai_insights_dashboard<span class="op">=</span>create_rai_job.outputs.rai_insights_dashboard,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>        erroranalysis_job.set_limits(timeout<span class="op">=</span><span class="dv">120</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Once all the RAI components are configured with the parameters needed for the use case, the next thing to do is add all of them into the list of insights to include on the RAI dashboard. Then upload the dashboard and UX settings for the RAI Dashboard.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>        rai_gather_job <span class="op">=</span> rai_gather_component(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>            constructor<span class="op">=</span>create_rai_job.outputs.rai_insights_dashboard,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>            insight_1<span class="op">=</span>explain_job.outputs.explanation,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>            insight_4<span class="op">=</span>erroranalysis_job.outputs.error_analysis,</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>        rai_gather_job.set_limits(timeout<span class="op">=</span><span class="dv">120</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The pipeline job outputs are the dashboard and UX config to be displayed.</p>
</section>
<section id="task-2-run-job-to-create-the-dashboard" class="level2">
<h2 class="anchored" data-anchor-id="task-2-run-job-to-create-the-dashboard">Task 2: Run job to create the dashboard</h2>
<p>After the pipeline is defined, we’ll initialize it by specifying the input parameters and the path to the it’s outputs. Lastly, we use the submit_and_wait function to run the pipeline and register it to the Azure ML workspace.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Pipeline Inputs</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>insights_pipeline_job <span class="op">=</span> rai_classification_pipeline(</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    target_column_name<span class="op">=</span>target_column,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    training_data<span class="op">=</span>hospital_train_parquet,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    testing_data<span class="op">=</span>hospital_test_parquet,</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Output workaround to enable the download</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>rand_path <span class="op">=</span> <span class="bu">str</span>(uuid.uuid4())</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>insights_pipeline_job.outputs.dashboard <span class="op">=</span> Output(</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    path<span class="op">=</span><span class="ss">f"azureml://datastores/workspaceblobstore/paths/</span><span class="sc">{</span>rand_path<span class="sc">}</span><span class="ss">/dashboard/"</span>,</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">"upload"</span>,</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>,</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>insights_pipeline_job.outputs.ux_json <span class="op">=</span> Output(</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    path<span class="op">=</span><span class="ss">f"azureml://datastores/workspaceblobstore/paths/</span><span class="sc">{</span>rand_path<span class="sc">}</span><span class="ss">/ux_json/"</span>,</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">"upload"</span>,</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>,</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="co"># submit and run pipeline</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>insights_job <span class="op">=</span> submit_and_wait(ml_client, insights_pipeline_job)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To monitor the progress of the pipeline job, click on the Jobs icon from the <a href="https://aka.ms/MBAzureMLStudio">Azure ML studio</a>. By clicking on the pipeline job, you can get the status.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="/img/azureml_jobs_page.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Azure ML jobs</figcaption><p></p>
</figure>
</div>
<p>To visualize the individual progression of each of the components in the pipeline, click on the pipeline name. This gives you a better view of which components are completed, pending, or failed.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="/img/rai-dashboard-pipeline.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Azure ML jobs progress</figcaption><p></p>
</figure>
</div>
<p>After the RAI dashboard pipeline job has successfully completed, click on the “Models” tab of the Azure ML studio to find your registered model. Then, select the name of the model you trained from the previous exercise.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="/img/model-list.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Azure ML Models</figcaption><p></p>
</figure>
</div>
<p>From the Model details page, click on the “Responsible AI” tab. Then select the name of the dashboard name.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="/img/model-details.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Azure ML Model details</figcaption><p></p>
</figure>
</div>
<p>Terrific…you now have an RAI dashboard.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="/img/rai-dashboard.gif" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Azure ML dasboard gif</figcaption><p></p>
</figure>
</div>
</section>
</section>
<section id="exercise-4-debug-your-model-with-responsible-ai-dashboard" class="level1">
<h1>Exercise 4: Debug your model with Responsible AI dashboard</h1>
<p>In this exercise, you will use the RAI dashboard to debug the diabetes hospital readmission classification model. Traditional machine learning performance metrics provide aggregated calculations which are insufficient to understand model errors distribution or if the model is behaving responsibly. The RAI dashboard provides a way to analysis where there are disparities in the model’s predictions, and understand the features that influence the model’s predictions. This exercise will explore area where there could be fairness, inclusiveness or reliability &amp; safety issues.</p>
<section id="task-1-error-analysis" class="level2">
<h2 class="anchored" data-anchor-id="task-1-error-analysis">Task 1: Error Analysis</h2>
</section>
<section id="task-2-model-overview" class="level2">
<h2 class="anchored" data-anchor-id="task-2-model-overview">Task 2: Model Overview</h2>
</section>
<section id="task-3-data-analysis" class="level2">
<h2 class="anchored" data-anchor-id="task-3-data-analysis">Task 3: Data Analysis</h2>
</section>
<section id="task-4-feature-importance" class="level2">
<h2 class="anchored" data-anchor-id="task-4-feature-importance">Task 4: Feature Importance</h2>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>